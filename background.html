<html>
<head>
<script type="text/javascript" src="lib/data_graph.js"></script> 
<script>
	var refreshInterval = 5*1000;
	
	var sesame4_upload_queue_data = new DataGraph(10, 120);
	var time = 0;

 	function get_url(name) {
 		var urls = {
 			'fcs_5': "https://members.sesamecommunications.com/support-tools/sesame/fast_client_search/",
 			'fcs_4': "https://www4.orthosesame.com/internal/fast_client_search/",
 			'upload_queue': "http://www.remindergenie.com/tech_support/upload_queue.cgi?queue_id=1"
 		};
 		return urls[name];
	}

 	
  	function refreshUploadQueueSize() {
		var xhr = new XMLHttpRequest();
		xhr.open("GET", get_url('upload_queue')+'&action=get_data', true);
		xhr.send();
		xhr.onreadystatechange = function() {
	    	//console.log("change");
		  	if (xhr.readyState == 4) {
		    	var resp = JSON.parse(xhr.responseText);
		    	//chrome.browserAction.setTitle({"title": "test"});
		    	//i++;
		    	setUploadQueueSize(resp);
		  	}
		}

    	//chrome.browserAction.setBadgeText({text:String(i)});
  	}
  	
  	function setUploadQueueSize(resp) {
    	var active_clients_count = 0;
    	var inactive_clients_count = 0;
    	var total_waits = 0;
    	var max_wait_time = 0;
    	var max_inactive_wait_time = 0;
    	for (var client_id in resp) {
    		total_waits += resp[client_id].waits;
    		if (resp[client_id].is_active) {
    			active_clients_count ++;
    		}
    		else {
    			inactive_clients_count ++;
	    		if (resp[client_id].waits > max_inactive_wait_time) {
	    			max_inactive_wait_time = resp[client_id].waits;
	    		}
    		}
    		if (resp[client_id].waits > max_wait_time) {
    			max_wait_time = resp[client_id].waits;
    		}
    	}
    	var total_clients_count = active_clients_count+inactive_clients_count;
    	chrome.browserAction.setBadgeText({"text": String(total_clients_count)});
	  	chrome.browserAction.setBadgeBackgroundColor({"color": getBadgeColorByQueueSize(total_clients_count)});
	  	var page_titles = [
	  		total_clients_count + " client" + (total_clients_count==1?" is":"s are") + " in the queue"
	  	];
	  	
	  	if (total_clients_count) {
		  	if (active_clients_count) {
		  		page_titles.push(active_clients_count + " client" + (total_clients_count==1?" is":"s are") + " processing");
		  	}
		  	page_titles.push("average waiting time: " + seconds_to_string(Math.round(total_waits/total_clients_count)));
		  	page_titles.push("max waiting time: " + seconds_to_string(max_inactive_wait_time));
		  	if (active_clients_count) {
			  	page_titles.push("max processing time: " + seconds_to_string(max_wait_time));
		  	}
		}
	  	chrome.browserAction.setTitle({"title": page_titles.join("\n")});
	  	
	  	time += 5;
	  	sesame4_upload_queue_data.add_point(time, total_clients_count);
  	}
  	
  	function getBadgeColorByQueueSize(queue_size) {
  		if (queue_size < 10) {
 			return [ 0, 132, 226, 255 ];
 		}
 		else if (queue_size < 50) {//50
  			return [ 0, 205, 0, 255 ];
  		}
 		else if (queue_size < 100) {//100
  			return [ 226, 189, 0, 255 ];
  		}
 		else {
  			return [ 255, 0, 0, 255 ];
  		}
  	}
  	
  	function seconds_to_string(seconds) {
		var days = Math.floor(seconds / (3600*24));
		seconds %= 3600*24;
		var hours = Math.floor(seconds / 3600);
		seconds %= 3600;
		var minutes = Math.floor(seconds / 60);
		seconds %= 60;
		var arr = [];
		if (days > 0) arr.push(days + "d");
		if (hours > 0) arr.push(hours + "h");
		if (minutes > 0) arr.push(minutes + "m");
		if (seconds > 0) arr.push(seconds + "s");
		if (arr.length > 2) arr = arr.slice(0, 2);
		return arr.join(" ");
	}
	
	function getCurrentSeconds() {
		var now = new Date();
		return Math.floor(Date.UTC(now));
	}

	function get_upload_queue_chart_settings() {
		return sesame4_upload_queue_data.get_chart_settings();
	}

  	window.setInterval(refreshUploadQueueSize, refreshInterval);
  	refreshUploadQueueSize()
</script>
</head>
</html>