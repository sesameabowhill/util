<html>
<head>
<script type="text/javascript" src="lib/data_graph.js"></script> 
<script type="text/javascript" src="lib/date_utils.js"></script> 
<script>
	
	var sesame4_upload_queue_data = new DataGraph(60, 120);
	var client_list;

 	function get_url(name) {
 		var urls = {
 			'fcs_5': "https://members.sesamecommunications.com/support-tools/sesame/fast_client_search/",
 			'fcs_4': "https://www4.orthosesame.com/internal/fast_client_search/",
 			'upload_queue': "http://www.remindergenie.com/tech_support/upload_queue.cgi?queue_id=1",
 			'client_api': "https://members.sesamecommunications.com/support-tools/sesame/clients-count.cgi?action=client_list"
 		};
 		return urls[name];
	}
	
	function get_refresh_interval(name) {
		var intervals = {
			'upload_queue': 15*1000,
			'client_list': 15*1000
		};
		return intervals[name];
	}

  	function get_json_data(url, processor) {
		var xhr = new XMLHttpRequest();
		xhr.open("GET", url, true);
		var http_user = localStorage["server_username"];
		if (http_user) {
			var http_password = atob(localStorage["server_password"]);
			xhr.setRequestHeader("Authorization", "Basic " + btoa( http_user + ":" + http_password ));
		}
		xhr.send();
		xhr.onreadystatechange = function() {
		  	if (xhr.readyState == 4) {
		    	var resp = JSON.parse(xhr.responseText);
		    	processor(resp);
		  	}
		}
  	}

  	function refresh_upload_queue_size() {
  		get_json_data(
  			get_url('upload_queue')+'&action=get_data',
  			set_upload_queue_size
  		);
  	}

  	function refresh_client_list() {
  		get_json_data(
  			get_url('client_api'),
  			function (clients) {
  				var status_str = {
  					"0": "inactive",
  					"1": "active"
  				};
  				var type_str = {
  					"s": "client",
  					"o": "ortho",
  					"d": "dental"
  				};
  				var version_str = {
  					"s": "sesame5",
  					"o": "sesame4",
  					"d": "sesame4"
  				};
  				client_list = {};
  				for (var i=0; i<clients.length; ++i) {
  					var cl = clients[i];
  					var new_cl;
  					if (client_list[cl.u]) {
  						if (cl.t == 's') {
  							new_cl = cl;
  						}
  					}
  					else {
  						new_cl = cl;
  					}
  					if (new_cl) {
	  					client_list[new_cl.u] = {
	  						"search_url": (new_cl.t == "s" ? get_url("fcs_5") : get_url("fcs_4")) + "?search_param=" + new_cl.u,
	  						"status": status_str[new_cl.s],
	  						"type": type_str[new_cl.t],
	  						"version": version_str[new_cl.t]
	  					};
	  				}
  				}
  			}
  		);
  	}
  	
  	function set_upload_queue_size(resp) {
    	var active_clients_count = 0;
    	var inactive_clients_count = 0;
    	var total_waits = 0;
    	var max_wait_time = 0;
    	var max_inactive_wait_time = 0;
    	for (var client_id in resp) {
    		total_waits += resp[client_id].waits;
    		if (resp[client_id].is_active) {
    			active_clients_count ++;
    		}
    		else {
    			inactive_clients_count ++;
	    		if (resp[client_id].waits > max_inactive_wait_time) {
	    			max_inactive_wait_time = resp[client_id].waits;
	    		}
    		}
    		if (resp[client_id].waits > max_wait_time) {
    			max_wait_time = resp[client_id].waits;
    		}
    	}
    	var total_clients_count = active_clients_count+inactive_clients_count;
    	chrome.browserAction.setBadgeText({"text": String(total_clients_count)});
	  	chrome.browserAction.setBadgeBackgroundColor({"color": get_badge_color_by_queue_size(total_clients_count)});
	  	var page_titles = [
	  		total_clients_count + " client" + (total_clients_count==1?" is":"s are") + " in the queue"
	  	];
	  	
	  	if (total_clients_count) {
		  	if (active_clients_count) {
		  		page_titles.push(active_clients_count + " client" + (total_clients_count==1?" is":"s are") + " processing");
		  	}
		  	page_titles.push("average waiting time: " + secondsToString(Math.round(total_waits/total_clients_count)));
		  	page_titles.push("max waiting time: " + secondsToString(max_inactive_wait_time));
		  	if (active_clients_count) {
			  	page_titles.push("max processing time: " + secondsToString(max_wait_time));
		  	}
		}
	  	chrome.browserAction.setTitle({"title": page_titles.join("\n")});
	  	
	  	sesame4_upload_queue_data.add_point(getCurrentSeconds(), total_clients_count);
  	}
  	
  	function get_badge_color_by_queue_size(queue_size) {
  		if (queue_size < 10) {
 			return [ 0, 132, 226, 255 ];
 		}
 		else if (queue_size < 50) {//50
  			return [ 0, 205, 0, 255 ];
  		}
 		else if (queue_size < 100) {//100
  			return [ 226, 189, 0, 255 ];
  		}
 		else {
  			return [ 255, 0, 0, 255 ];
  		}
  	}
  	

	function get_upload_queue_chart_settings() {
		return sesame4_upload_queue_data.get_chart_settings();
	}

  	window.setInterval(refresh_upload_queue_size, get_refresh_interval('upload_queue'));
  	window.setInterval(refresh_client_list, get_refresh_interval('client_list'));
  	refresh_upload_queue_size();
  	refresh_client_list();
  	
  	chrome.extension.onRequest.addListener(
		function(request, sender, sendResponse) {
			if (request.action == "get_clients") {
				sendResponse({
					"clients": client_list
				});
			}
			else {
				sendResponse({}); // snub them.
			}
		}
	);
</script>
</head>
</html>